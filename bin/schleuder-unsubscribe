#!/usr/bin/ruby

if ![2,3].include?(ARGV.size) || ARGV.first.match(/^-h|--help/)
  puts <<EOF
This script unsubscribes an email-address from a schleuder-list.
Specify a fingerprint to delete the public key from the list's key-ring.
Usage: #{File.basename(__FILE__)} list@hostname user@example.org [fingerprint]"
EOF
  exit 1
end

listname, email, fingerprint  = ARGV

def error(msgs)
  Array(msgs).each do |msg|
    $stderr.puts "Error: #{msg}"
  end
  exit 1
end

require_relative '../lib/schleuder.rb'

list = List.where(email: listname).first

if list.blank?
  error "No such list."
end

subscription = list.subscriptions.where(email: email).first

if ! subscription
  error "Address is not subscribed."
end

if subscription.destroy
  puts "#{email} unsubscribed."
end

if fingerprint
  # TODO: use gpgme
  puts "Deleteing key from keyring: "
  puts `gpg --homedir "#{list.listdir}" --batch --delete-key "#{keyfile}"`
end
