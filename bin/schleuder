#!/usr/bin/ruby

if ARGV.empty? || ARGV.first.match(/-h|--help/)
  puts "Usage: #{File.basename(__FILE__)} listname < message"
  exit 1
elsif ARGV.first.match(/-v|-V|--version/)
  require_relative '../lib/schleuder/version.rb'
  puts Schleuder::VERSION
  exit 0
end

listname = ARGV.first
message  = STDIN.read

begin
  require_relative '../lib/schleuder.rb'

  error = Schleuder::Runner.new.run(message, listname)
  if error
    puts error
    exit 1
  end
rescue => exc
  begin
    Schleuder.logger.fatal(exc.to_s, message)
    puts I18n.t('errors.fatalerror')
  rescue => e
    # Give users a clue what to do in case everything blows up.
    # As apparently even the logging raised exceptions we can't even store
    # any information in the logs.
    puts "A serious, unhandleable error happened. Please contact the administrators of this system or service and provide them with the following information:\n\n#{e}"
  end
  exit 1
end
