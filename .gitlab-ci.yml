---
stages:
  - test
  - docker

cache:
  key: "$CI_PROJECT_PATH_SLUG-$CI_JOB_NAME"
  paths:
    - vendor

# Jobs that start with a period are disabled
# This is just a template, to be used further below in the individual ruby rspec job definitions
.test_ruby: &test_ruby
  before_script:
    # Export APT env vars to cache packages archives and lists based on the current working directory
    - export APT_DIR=$CI_PROJECT_DIR/vendor/apt && export APT_ARCHIVES_DIR=$APT_DIR/archives && export APT_LISTS_DIR=$APT_DIR/lists
    # Configure APT: Only install necessary packages, set cache location
    - printf
      "apt::install-recommends 0;\n
      apt::install-suggests 0;\n
      dir::cache::archives ${APT_ARCHIVES_DIR};\n
      dir::state::lists ${APT_LISTS_DIR};\n"
      >> /etc/apt/apt.conf.d/99custom
    # Ensure the custom APT directory does exist
    - mkdir -p {${APT_ARCHIVES_DIR},${APT_LISTS_DIR}}/partial
    # Check the mtime of the files in the APT lists dir, to update the APT package cache only if it's empty,
    # or the last run was (more than) 14 days ago
    - if [ -z "$(find ${APT_LISTS_DIR} -maxdepth 1 -type f -mtime -14)" ]; then
      apt-get update -qq;
      fi
    - apt-get install -qq -y gnupg2 libgpgme11-dev libsqlite3-dev eatmydata
    - eatmydata gem install bundler --no-ri --no-rdoc
    - eatmydata bundle install --jobs $(nproc) --path vendor
    - rm /dev/random && ln -s /dev/urandom /dev/random
    - SCHLEUDER_ENV=test SCHLEUDER_CONFIG=spec/schleuder.yml eatmydata bundle exec rake db:init
  script:
    - eatmydata bundle exec rspec

ruby:2.1:
  image: ruby:2.1
  <<: *test_ruby
ruby:2.2:
  image: ruby:2.2
  <<: *test_ruby
ruby:2.3:
  image: ruby:2.3
  <<: *test_ruby
ruby:2.4:
  image: ruby:2.4
  <<: *test_ruby
ruby:2.5:
  image: ruby:2.5
  <<: *test_ruby

bundler:audit:
  image: ruby:2.5
  only:
    - schedules
  script:
    - gem install bundler-audit --no-ri --no-rdoc
    - bundle install --jobs $(nproc) --path vendor
    - bundle-audit update
    - bundle-audit check

build_docker_image:
  stage: docker
  # Only build packages for https://0xacab.org/schleuder/schleuder, not
  # for forks
  only:
    - master@schleuder/schleuder
    - tags@schleuder/schleuder
  tags:
    - docker-in-docker
  image: docker:latest
  services:
    - docker:dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
  script:
    - docker build -t $IMAGE_TAG .
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker push $IMAGE_TAG
